<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Gen 1 & 2 Pokédex Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .pokedex-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
            gap: 1rem; /* Tailwind gap-4 */
        }
        .pokemon-card {
            background-color: white;
            border-radius: 0.5rem; /* Tailwind rounded-lg */
            padding: 1rem; /* Tailwind p-4 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* Tailwind shadow-md */
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .pokemon-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Tailwind shadow-xl */
        }
        .pokemon-sprite {
            width: 72px; /* Tailwind w-18 */
            height: 72px; /* Tailwind h-18 */
            image-rendering: pixelated; /* Keep sprites sharp */
        }
        .caught-checkbox {
            width: 1.25rem; /* Tailwind w-5 */
            height: 1.25rem; /* Tailwind h-5 */
        }
        .info-button {
            margin-top: 0.25rem; /* Tailwind mt-1 */
            padding: 0.25rem 0.75rem; /* Tailwind px-3 py-1 */
            font-size: 0.75rem; /* Tailwind text-xs */
            border-radius: 0.375rem; /* Tailwind rounded-md */
        }
        .next-to-catch {
            border: 2px solid #3b82f6; /* Tailwind blue-500 */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888;
            width: 80%; max-width: 500px; border-radius: 0.5rem; text-align: center;
        }
        .close-button {
            color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }

        .tab-button {
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            border-radius: 0.375rem 0.375rem 0 0;
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-600 */
            cursor: pointer;
            font-weight: 500;
        }
        .tab-button.active {
            background-color: #60a5fa; /* blue-400 */
            color: white;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .filter-container, .view-container {
            background-color: white; padding: 1rem; margin-bottom: 1.5rem;
            border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
        }
        .form-select, .form-input {
            padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; width: 100%;
        }
        .availability-note {
            font-size: 0.75rem; /* text-xs */
            color: #ef4444; /* red-500 */
            margin-top: 0.25rem; /* mt-1 */
            font-style: italic;
        }
        .type-badge {
            display: inline-block; padding: 0.25em 0.6em; font-size: 0.75em; font-weight: 700;
            line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline;
            border-radius: 0.25rem; margin: 0.1rem;
        }
        /* Type colors (same as before) */
        .type-grass { background-color: #78C850; color: white; } .type-poison { background-color: #A040A0; color: white; }
        .type-fire { background-color: #F08030; color: white; } .type-flying { background-color: #A890F0; color: white; }
        .type-water { background-color: #6890F0; color: white; } .type-bug { background-color: #A8B820; color: white; }
        .type-normal { background-color: #A8A878; color: white; } .type-electric { background-color: #F8D030; color: black; }
        .type-ground { background-color: #E0C068; color: black; } .type-fairy { background-color: #EE99AC; color: black; }
        .type-fighting { background-color: #C03028; color: white; } .type-psychic { background-color: #F85888; color: white; }
        .type-rock { background-color: #B8A038; color: white; } .type-steel { background-color: #B8B8D0; color: black; }
        .type-ice { background-color: #98D8D8; color: black; } .type-ghost { background-color: #705898; color: white; }
        .type-dragon { background-color: #7038F8; color: white; } .type-dark { background-color: #705848; color: white; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-800">Advanced Pokédex Tracker</h1>
            <div class="mt-2">
                <label for="gameSelector" class="mr-2 text-lg text-gray-700">Current Game:</label>
                <select id="gameSelector" class="form-select w-auto inline-block p-2 border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <option value="gold">Pokémon Gold</option>
                    <option value="silver">Pokémon Silver</option>
                    <option value="crystal" disabled>Pokémon Crystal (data pending)</option>
                    <option value="red">Pokémon Red</option>
                    <option value="blue">Pokémon Blue</option>
                    <option value="yellow">Pokémon Yellow</option>
                </select>
            </div>
        </header>

        <div class="mb-4 border-b border-gray-300">
            <nav class="flex" aria-label="Tabs">
                <button class="tab-button active" data-tab="pokedexView">Full Pokédex</button>
                <button class="tab-button" data-tab="areaDexView">Area Dex</button>
                <button class="tab-button" data-tab="tradeHelperView">Trade Helper</button>
            </nav>
        </div>

        <div id="pokedexView" class="tab-content active">
            <div class="filter-container">
                <input type="text" id="searchInput" class="form-input mb-2" placeholder="Search by name or Pokédex number...">
                <label class="inline-flex items-center">
                    <input type="checkbox" id="showUncaughtOnly" class="form-checkbox h-5 w-5 text-blue-600 rounded">
                    <span class="ml-2 text-gray-700">Show Uncaught Pokémon Only</span>
                </label>
            </div>
            <div id="pokedexGrid" class="pokedex-grid"></div>
        </div>

        <div id="areaDexView" class="tab-content">
            <div class="view-container">
                <h2 class="text-2xl font-semibold mb-3 text-gray-700">Area Dex</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="areaGameSelector" class="block text-sm font-medium text-gray-700">Select Game:</label>
                        <select id="areaGameSelector" class="form-select mt-1"></select>
                    </div>
                    <div>
                        <label for="areaSelector" class="block text-sm font-medium text-gray-700">Select Area:</label>
                        <select id="areaSelector" class="form-select mt-1">
                            <option value="">-- Select a Game First --</option>
                        </select>
                    </div>
                </div>
                <div id="areaPokemonGrid" class="pokedex-grid">
                    <p class="col-span-full text-center text-gray-500">Select a game and area to see Pokémon.</p>
                </div>
            </div>
        </div>

        <div id="tradeHelperView" class="tab-content">
            <div class="view-container">
                <h2 class="text-2xl font-semibold mb-3 text-gray-700">Trade Helper</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="tradeMyGameSelector" class="block text-sm font-medium text-gray-700">My Game:</label>
                        <select id="tradeMyGameSelector" class="form-select mt-1"></select>
                    </div>
                    <div>
                        <label for="tradePartnerGameSelector" class="block text-sm font-medium text-gray-700">Partner's Game:</label>
                        <select id="tradePartnerGameSelector" class="form-select mt-1"></select>
                    </div>
                </div>
                <button id="findTradesButton" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mb-4">Find Trades</button>
                <div id="tradeResultsContainer">
                    <div id="canReceiveTrades" class="mb-4">
                        <h3 class="text-xl font-medium text-gray-700">Pokémon I Can Receive:</h3>
                        <ul id="canReceiveTradesList" class="list-disc pl-5"></ul>
                    </div>
                    <div id="canSendTrades">
                        <h3 class="text-xl font-medium text-gray-700">Pokémon I Can Send (Partner Needs):</h3>
                        <ul id="canSendTradesList" class="list-disc pl-5"></ul>
                    </div>
                     <p id="tradeResultsPlaceholder" class="text-center text-gray-500">Select games and click "Find Trades".</p>
                </div>
            </div>
        </div>
    </div>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2 id="modalPokemonName" class="text-2xl font-bold mb-2"></h2>
            <img id="modalPokemonSprite" src="" alt="Pokemon Sprite" class="mx-auto mb-4 w-24 h-24 image-rendering-pixelated">
            <p id="modalCatchInfo" class="text-gray-700"></p>
            <p id="modalAvailabilityNote" class="text-sm text-red-600 italic mt-2"></p>
        </div>
    </div>

    <script>
        // --- DATA ---
        // NOTE: Availability data is extensive. Populated a few examples fully.
        // Others have placeholder availability. You'll need to complete this.
        const pokemonData = [
            // --- Generation 1 ---
            { id: 1, name: "Bulbasaur", types: ["Grass", "Poison"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, locations: [], note: "Trade from R/B/Y. Starter in Kanto (post-game via Time Capsule)."}, silver: {catchable: false, locations: [], note: "Trade from R/B/Y. Starter in Kanto (post-game via Time Capsule)."}, crystal: {catchable: false, locations: [], note: "Trade from R/B/Y. Starter in Kanto (post-game via Time Capsule)."}, red: {catchable: true, locations: ["Pallet Town (Starter)"], note: ""}, blue: {catchable: true, locations: ["Pallet Town (Starter)"], note: ""}, yellow: {catchable: true, locations: ["Cerulean City (gift)"], note: ""} } },
            { id: 2, name: "Ivysaur", types: ["Grass", "Poison"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Evolve Bulbasaur."}, silver: {catchable: false, note: "Evolve Bulbasaur."}, crystal: {catchable: false, note: "Evolve Bulbasaur."}, red: {catchable: false, note: "Evolve Bulbasaur."}, blue: {catchable: false, note: "Evolve Bulbasaur."}, yellow: {catchable: false, note: "Evolve Bulbasaur."} } },
            { id: 3, name: "Venusaur", types: ["Grass", "Poison"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Evolve Ivysaur."}, silver: {catchable: false, note: "Evolve Ivysaur."}, crystal: {catchable: false, note: "Evolve Ivysaur."}, red: {catchable: false, note: "Evolve Ivysaur."}, blue: {catchable: false, note: "Evolve Ivysaur."}, yellow: {catchable: false, note: "Evolve Ivysaur."} } },
            { id: 4, name: "Charmander", types: ["Fire"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, locations: [], note: "Trade from R/B/Y. Starter in Kanto (post-game via Time Capsule)."}, silver: {catchable: false, locations: [], note: "Trade from R/B/Y. Starter in Kanto (post-game via Time Capsule)."}, crystal: {catchable: false, locations: [], note: "Trade from R/B/Y. Starter in Kanto (post-game via Time Capsule)."}, red: {catchable: true, locations: ["Pallet Town (Starter)"], note: ""}, blue: {catchable: true, locations: ["Pallet Town (Starter)"], note: ""}, yellow: {catchable: true, locations: ["Route 24 (gift)"], note: ""} } },
            { id: 5, name: "Charmeleon", types: ["Fire"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Evolve Charmander."}, silver: {catchable: false, note: "Evolve Charmander."}, crystal: {catchable: false, note: "Evolve Charmander."}, red: {catchable: false, note: "Evolve Charmander."}, blue: {catchable: false, note: "Evolve Charmander."}, yellow: {catchable: false, note: "Evolve Charmander."} } },
            { id: 6, name: "Charizard", types: ["Fire", "Flying"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Evolve Charmeleon."}, silver: {catchable: false, note: "Evolve Charmeleon."}, crystal: {catchable: false, note: "Evolve Charmeleon."}, red: {catchable: false, note: "Evolve Charmeleon."}, blue: {catchable: false, note: "Evolve Charmeleon."}, yellow: {catchable: false, note: "Evolve Charmeleon."} } },
            { id: 7, name: "Squirtle", types: ["Water"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, locations: [], note: "Trade from R/B/Y. Starter in Kanto (post-game via Time Capsule)."}, silver: {catchable: false, locations: [], note: "Trade from R/B/Y. Starter in Kanto (post-game via Time Capsule)."}, crystal: {catchable: false, locations: [], note: "Trade from R/B/Y. Starter in Kanto (post-game via Time Capsule)."}, red: {catchable: true, locations: ["Pallet Town (Starter)"], note: ""}, blue: {catchable: true, locations: ["Pallet Town (Starter)"], note: ""}, yellow: {catchable: true, locations: ["Vermilion City (gift)"], note: ""} } },
            { id: 8, name: "Wartortle", types: ["Water"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Evolve Squirtle."}, silver: {catchable: false, note: "Evolve Squirtle."}, crystal: {catchable: false, note: "Evolve Squirtle."}, red: {catchable: false, note: "Evolve Squirtle."}, blue: {catchable: false, note: "Evolve Squirtle."}, yellow: {catchable: false, note: "Evolve Squirtle."} } },
            { id: 9, name: "Blastoise", types: ["Water"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Evolve Wartortle."}, silver: {catchable: false, note: "Evolve Wartortle."}, crystal: {catchable: false, note: "Evolve Wartortle."}, red: {catchable: false, note: "Evolve Wartortle."}, blue: {catchable: false, note: "Evolve Wartortle."}, yellow: {catchable: false, note: "Evolve Wartortle."} } },
            { id: 10, name: "Caterpie", types: ["Bug"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["Routes 2, 30, 31", "Ilex Forest", "National Park (Bug Contest)"], note: ""}, silver: {catchable: true, locations: ["Routes 2, 30, 31", "Ilex Forest", "National Park (Bug Contest)"], note: ""}, crystal: {catchable: true, locations: ["Routes 2, 30, 31", "Ilex Forest", "National Park"], note: ""}, red: {catchable: true, locations: ["Viridian Forest", "Route 2, 24, 25"], note: ""}, blue: {catchable: false, note: "Trade from Red/Yellow."}, yellow: {catchable: true, locations: ["Viridian Forest", "Route 2"], note: ""} } },
            // ... (Continue for Caterpie evolutions and other Gen 1 common Pokémon with similar availability logic)
            { id: 23, name: "Ekans", types: ["Poison"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Trade from Silver/Red/Blue/Yellow."}, silver: {catchable: true, locations: ["Route 3, 4, 32, 33", "Goldenrod Game Corner"], note: ""}, crystal: {catchable: true, locations: ["Route 3, 4, 32, 33"], note: ""}, red: {catchable: true, locations: ["Route 4, 11, 23"], note: ""}, blue: {catchable: false, note: "Trade from Red."}, yellow: {catchable: false, note: "Trade from Red."} } },
            { id: 24, name: "Arbok", types: ["Poison"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Evolve Ekans. Trade from Silver/Red/Blue/Yellow."}, silver: {catchable: true, locations: ["Route 3, 4, 26, 27", "Mt. Mortar"], note: "Evolve Ekans."}, crystal: {catchable: true, locations: ["Route 3, 4, 26, 27", "Mt. Mortar"], note: "Evolve Ekans."}, red: {catchable: true, locations: ["Route 23", "Cerulean Cave"], note: "Evolve Ekans."}, blue: {catchable: false, note: "Evolve Ekans. Trade from Red."}, yellow: {catchable: false, note: "Evolve Ekans. Trade from Red."} } },
            { id: 27, name: "Sandshrew", types: ["Ground"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["Union Cave", "Mt. Moon (Kanto)", "Goldenrod Game Corner"], note: ""}, silver: {catchable: false, note: "Trade from Gold/Red/Blue/Yellow."}, crystal: {catchable: true, locations: ["Union Cave", "Mt. Moon (Kanto)"], note: ""}, red: {catchable: false, note: "Trade from Blue/Yellow."}, blue: {catchable: true, locations: ["Route 4, 11, 23"], note: ""}, yellow: {catchable: true, locations: ["Route 3, 4"], note: ""} } },
            { id: 28, name: "Sandslash", types: ["Ground"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["Route 26, 27", "Mt. Moon (Kanto)"], note: "Evolve Sandshrew."}, silver: {catchable: false, note: "Evolve Sandshrew. Trade from Gold/Red/Blue/Yellow."}, crystal: {catchable: true, locations: ["Route 26, 27", "Mt. Moon (Kanto)"], note: "Evolve Sandshrew."}, red: {catchable: false, note: "Evolve Sandshrew. Trade from Blue/Yellow."}, blue: {catchable: true, locations: ["Route 23", "Cerulean Cave"], note: "Evolve Sandshrew."}, yellow: {catchable: true, locations: ["Route 23", "Cerulean Cave"], note: "Evolve Sandshrew."} } },
            { id: 37, name: "Vulpix", types: ["Fire"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Trade from Silver/Crystal/Red/Yellow. Or Kanto (post-game)."}, silver: {catchable: true, locations: ["Route 7, 8, 36, 37"], note: ""}, crystal: {catchable: true, locations: ["Route 7, 8, 36, 37, 38"], note: ""}, red: {catchable: false, note: "Trade from Yellow."}, blue: {catchable: false, note: "Trade from Yellow."}, yellow: {catchable: true, locations: ["Route 7, 8", "Celadon City (Game Corner)"], note: ""} } },
            { id: 38, name: "Ninetales", types: ["Fire"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Evolve Vulpix."}, silver: {catchable: false, note: "Evolve Vulpix."}, crystal: {catchable: false, note: "Evolve Vulpix."}, red: {catchable: false, note: "Evolve Vulpix."}, blue: {catchable: false, note: "Evolve Vulpix."}, yellow: {catchable: false, note: "Evolve Vulpix."} } },
            { id: 52, name: "Meowth", types: ["Normal"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Trade from Silver/Blue/Yellow. Or Kanto (post-game)."}, silver: {catchable: true, locations: ["Route 5, 6, 7, 8, 38, 39"], note: ""}, crystal: {catchable: true, locations: ["Route 5, 6, 7, 8, 38, 39"], note: ""}, red: {catchable: false, note: "Trade from Blue/Yellow."}, blue: {catchable: true, locations: ["Route 5, 6, 7, 8"], note: ""}, yellow: {catchable: false, note: "Trade from Blue."} } },
            { id: 56, name: "Mankey", types: ["Fighting"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["Route 9, 42"], note: ""}, silver: {catchable: false, note: "Trade from Gold/Red/Yellow."}, crystal: {catchable: true, locations: ["Route 9, 42"], note: ""}, red: {catchable: true, locations: ["Route 5, 6, 7, 8"], note: ""}, blue: {catchable: false, note: "Trade from Red/Yellow."}, yellow: {catchable: true, locations: ["Route 3, 4, 22, 23"], note: ""} } },
            { id: 58, name: "Growlithe", types: ["Fire"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["Route 7, 8, 36, 37"], note: ""}, silver: {catchable: false, note: "Trade from Gold/Crystal/Red/Yellow."}, crystal: {catchable: true, locations: ["Route 7, 8, 36, 37, 38"], note: ""}, red: {catchable: true, locations: ["Route 5, 6, 7, 8", "Pokémon Mansion"], note: ""}, blue: {catchable: false, note: "Trade from Red/Yellow."}, yellow: {catchable: false, note: "Trade from Red."} } },
            // ... (Many Gen 1 Pokémon would follow here, with placeholders or full data)
            { id: 123, name: "Scyther", types: ["Bug", "Flying"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["National Park (Bug Contest)", "Goldenrod Game Corner"], note: ""}, silver: {catchable: true, locations: ["National Park (Bug Contest)"], note: "Trade from Gold for Game Corner."}, crystal: {catchable: true, locations: ["National Park (Bug Contest)", "Goldenrod Game Corner"], note: ""}, red: {catchable: true, locations: ["Safari Zone", "Celadon Game Corner"], note: ""}, blue: {catchable: false, note: "Trade from Red/Yellow."}, yellow: {catchable: true, locations: ["Safari Zone"], note: ""} } },
            { id: 127, name: "Pinsir", types: ["Bug"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["National Park (Bug Contest)"], note: "Trade from Silver for Game Corner."}, silver: {catchable: true, locations: ["National Park (Bug Contest)", "Goldenrod Game Corner"], note: ""}, crystal: {catchable: true, locations: ["National Park (Bug Contest)", "Goldenrod Game Corner"], note: ""}, red: {catchable: false, note: "Trade from Blue/Yellow."}, blue: {catchable: true, locations: ["Safari Zone", "Celadon Game Corner"], note: ""}, yellow: {catchable: true, locations: ["Safari Zone"], note: ""} } },
            { id: 143, name: "Snorlax", types: ["Normal"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["Route 11 (Kanto, wake with Poké Flute Radio)"], note: ""}, silver: {catchable: true, locations: ["Route 11 (Kanto, wake with Poké Flute Radio)"], note: ""}, crystal: {catchable: true, locations: ["Route 11 (Kanto, wake with Poké Flute Radio)"], note: ""}, red: {catchable: true, locations: ["Route 12, 16 (wake with Poké Flute)"], note: ""}, blue: {catchable: true, locations: ["Route 12, 16 (wake with Poké Flute)"], note: ""}, yellow: {catchable: true, locations: ["Route 12, 16 (wake with Poké Flute)"], note: ""} } },
            // --- Generation 2 ---
            { id: 152, name: "Chikorita", types: ["Grass"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["New Bark Town (Starter)"], note: ""}, silver: {catchable: true, locations: ["New Bark Town (Starter)"], note: ""}, crystal: {catchable: true, locations: ["New Bark Town (Starter)"], note: ""}, red: {catchable: false, note:"Trade from G/S/C."}, blue: {catchable: false, note:"Trade from G/S/C."}, yellow: {catchable: false, note:"Trade from G/S/C."} } },
            // ... (Starters and their evolutions)
            { id: 165, name: "Ledyba", types: ["Bug", "Flying"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Trade from Silver/Crystal."}, silver: {catchable: true, locations: ["Route 2, 30, 31, 37 (Morning)"], note: ""}, crystal: {catchable: true, locations: ["Route 2, 30, 31, 36, 37 (Morning)"], note: ""}, red: {catchable: false, note:"Trade from G/S/C."}, blue: {catchable: false, note:"Trade from G/S/C."}, yellow: {catchable: false, note:"Trade from G/S/C."} } },
            { id: 167, name: "Spinarak", types: ["Bug", "Poison"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["Route 2, 30, 31, 37 (Night)"], note: ""}, silver: {catchable: false, note: "Trade from Gold/Crystal."}, crystal: {catchable: true, locations: ["Route 2, 30, 31, 36, 37 (Night)"], note: ""}, red: {catchable: false, note:"Trade from G/S/C."}, blue: {catchable: false, note:"Trade from G/S/C."}, yellow: {catchable: false, note:"Trade from G/S/C."} } },
            { id: 207, name: "Gligar", types: ["Ground", "Flying"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["Route 45"], note: ""}, silver: {catchable: false, note: "Trade from Gold/Crystal."}, crystal: {catchable: true, locations: ["Route 45"], note: ""}, red: {catchable: false, note:"Trade from G/S/C."}, blue: {catchable: false, note:"Trade from G/S/C."}, yellow: {catchable: false, note:"Trade from G/S/C."} } },
            { id: 216, name: "Teddiursa", types: ["Normal"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["Route 45 (Morning)", "Dark Cave (Route 45 side, Morning)"], note: ""}, silver: {catchable: false, note: "Trade from Gold/Crystal."}, crystal: {catchable: true, locations: ["Route 45 (Morning)", "Dark Cave (Route 45 side, Morning)", "Mt. Silver"], note: ""}, red: {catchable: false, note:"Trade from G/S/C."}, blue: {catchable: false, note:"Trade from G/S/C."}, yellow: {catchable: false, note:"Trade from G/S/C."} } },
            { id: 225, name: "Delibird", types: ["Ice", "Flying"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Trade from Silver/Crystal."}, silver: {catchable: true, locations: ["Ice Path"], note: ""}, crystal: {catchable: true, locations: ["Ice Path"], note: ""}, red: {catchable: false, note:"Trade from G/S/C."}, blue: {catchable: false, note:"Trade from G/S/C."}, yellow: {catchable: false, note:"Trade from G/S/C."} } },
            { id: 226, name: "Mantine", types: ["Water", "Flying"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: true, locations: ["Route 41 (Surf)"], note: ""}, silver: {catchable: false, note: "Trade from Gold/Crystal."}, crystal: {catchable: true, locations: ["Route 41 (Surf)"], note: "More common in Crystal."}, red: {catchable: false, note:"Trade from G/S/C."}, blue: {catchable: false, note:"Trade from G/S/C."}, yellow: {catchable: false, note:"Trade from G/S/C."} } },
            { id: 227, name: "Skarmory", types: ["Steel", "Flying"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Trade from Silver/Crystal."}, silver: {catchable: true, locations: ["Route 45", "Mt. Silver (outside)"], note: ""}, crystal: {catchable: true, locations: ["Route 45", "Mt. Silver (outside)"], note: ""}, red: {catchable: false, note:"Trade from G/S/C."}, blue: {catchable: false, note:"Trade from G/S/C."}, yellow: {catchable: false, note:"Trade from G/S/C."} } },
            { id: 231, name: "Phanpy", types: ["Ground"], spriteBase: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/", availability: { gold: {catchable: false, note: "Trade from Silver/Crystal."}, silver: {catchable: true, locations: ["Route 45 (Morning)", "Dark Cave (Route 45 side, Morning)"], note: ""}, crystal: {catchable: true, locations: ["Route 45 (Morning)", "Dark Cave (Route 45 side, Morning)", "Mt. Silver"], note: ""}, red: {catchable: false, note:"Trade from G/S/C."}, blue: {catchable: false, note:"Trade from G/S/C."}, yellow: {catchable: false, note:"Trade from G/S/C."} } },
            // ... (Many more Pokémon would follow here)
            // For brevity, the rest will use a simplified placeholder structure for availability
        ];

        // --- UTILITY FUNCTIONS for Pokemon Data ---
        pokemonData.forEach(p => {
            // Ensure all game versions have a basic availability structure if not fully defined
            const games = ["gold", "silver", "crystal", "red", "blue", "yellow"];
            games.forEach(game => {
                if (!p.availability[game]) {
                    p.availability[game] = { catchable: false, locations: [], note: "Data pending or trade from other versions." };
                }
                if (!p.availability[game].locations) p.availability[game].locations = [];
                if (typeof p.availability[game].catchable === 'undefined') p.availability[game].catchable = p.availability[game].locations.length > 0;

            });

            // Add the getCatchInfoForGame method if not present (for ones not fully defined above)
             if (!p.getCatchInfoForGame) {
                p.getCatchInfoForGame = function(gameKey) {
                    const avail = this.availability[gameKey];
                    if (avail) {
                        let info = "";
                        if (avail.locations && avail.locations.length > 0) {
                            info += "Locations: " + avail.locations.join(', ') + ". ";
                        }
                        if (avail.note) {
                            info += avail.note;
                        }
                        return info.trim() || "No specific catch info for this game in current data.";
                    }
                    return "Catch info not available.";
                };
            }
            // Set full sprite URL
            p.sprite = `${p.spriteBase}${p.id}.png`;
        });


        // --- DOM Elements ---
        const gameSelector = document.getElementById('gameSelector');
        const pokedexGrid = document.getElementById('pokedexGrid');
        const searchInput = document.getElementById('searchInput');
        const showUncaughtOnlyCheckbox = document.getElementById('showUncaughtOnly');

        const modal = document.getElementById('infoModal');
        const modalPokemonName = document.getElementById('modalPokemonName');
        const modalPokemonSprite = document.getElementById('modalPokemonSprite');
        const modalCatchInfo = document.getElementById('modalCatchInfo');
        const modalAvailabilityNote = document.getElementById('modalAvailabilityNote');

        const areaGameSelector = document.getElementById('areaGameSelector');
        const areaSelector = document.getElementById('areaSelector');
        const areaPokemonGrid = document.getElementById('areaPokemonGrid');

        const tradeMyGameSelector = document.getElementById('tradeMyGameSelector');
        const tradePartnerGameSelector = document.getElementById('tradePartnerGameSelector');
        const findTradesButton = document.getElementById('findTradesButton');
        const canReceiveTradesList = document.getElementById('canReceiveTradesList');
        const canSendTradesList = document.getElementById('canSendTradesList');
        const tradeResultsPlaceholder = document.getElementById('tradeResultsPlaceholder');

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // --- STATE ---
        let currentGame = gameSelector.value || 'gold';
        let caughtDataForCurrentGame = {}; // { pokemonId: true/false }
        let allLoadedCaughtData = {}; // { gameName: { pokemonId: true/false } }
        let allGameLocations = {}; // { gameName: ["Area1", "Area2"] }


        // --- INITIALIZATION ---
        async function initializeApp() {
            populateGameSelectors();
            await switchGame(currentGame, true); // Initial load for the default game

            gameSelector.addEventListener('change', (e) => switchGame(e.target.value));
            searchInput.addEventListener('input', renderPokedexView);
            showUncaughtOnlyCheckbox.addEventListener('change', renderPokedexView);

            // Tab switching logic
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    tabContents.forEach(content => {
                        content.classList.toggle('active', content.id === tabId);
                    });
                    if (tabId === 'areaDexView') initializeAreaDex();
                    if (tabId === 'tradeHelperView') initializeTradeHelper();
                });
            });

            // Area Dex listeners
            areaGameSelector.addEventListener('change', handleAreaGameChange);
            areaSelector.addEventListener('change', renderAreaPokemon);

            // Trade Helper listener
            findTradesButton.addEventListener('click', executeTradeSearch);

            // Initialize the first tab's specific setup if needed
            if (document.querySelector('.tab-button.active').dataset.tab === 'pokedexView') {
                // pokedexView is default, already handled by switchGame
            }
        }

        function populateGameSelectors() {
            const games = [
                { value: "gold", text: "Pokémon Gold" },
                { value: "silver", text: "Pokémon Silver" },
                { value: "crystal", text: "Pokémon Crystal (Data Pending)", disabled: true },
                { value: "red", text: "Pokémon Red" },
                { value: "blue", text: "Pokémon Blue" },
                { value: "yellow", text: "Pokémon Yellow" }
            ];

            [areaGameSelector, tradeMyGameSelector, tradePartnerGameSelector].forEach(selector => {
                selector.innerHTML = ''; // Clear existing
                games.forEach(game => {
                    if (selector === gameSelector && game.value === "crystal") return; // Skip Crystal for main selector for now
                    const option = document.createElement('option');
                    option.value = game.value;
                    option.textContent = game.text;
                    option.disabled = !!game.disabled;
                    selector.appendChild(option);
                });
            });
            // Set initial values for trade helper to avoid same game selection issues
            if (games.length > 1) {
                tradeMyGameSelector.value = games[0].value;
                tradePartnerGameSelector.value = games[1].value;
            }
        }


        // --- GAME SWITCHING & DATA HANDLING ---
        async function switchGame(newGameKey, isInitialLoad = false) {
            currentGame = newGameKey;
            if (!isInitialLoad) { // gameSelector is the main one, update others if they exist
                 if (areaGameSelector.value !== currentGame && areaGameSelector.options.namedItem(currentGame) && !areaGameSelector.options.namedItem(currentGame).disabled) areaGameSelector.value = currentGame;
                 if (tradeMyGameSelector.value !== currentGame && tradeMyGameSelector.options.namedItem(currentGame) && !tradeMyGameSelector.options.namedItem(currentGame).disabled) tradeMyGameSelector.value = currentGame;
            }
            console.log(`Switched to game: ${currentGame}`);
            await loadCaughtDataForGame(currentGame);
            renderPokedexView();
            if (document.getElementById('areaDexView').classList.contains('active')) initializeAreaDex();
            if (document.getElementById('tradeHelperView').classList.contains('active')) initializeTradeHelper();
        }

        async function loadCaughtDataForGame(gameKey, forceReload = false) {
            if (!forceReload && allLoadedCaughtData[gameKey]) {
                caughtDataForCurrentGame = allLoadedCaughtData[gameKey];
                console.log(`Using cached caught data for ${gameKey}`);
                return;
            }
            try {
                const response = await fetch(`/caught/${gameKey}`);
                if (!response.ok) {
                    if (response.status === 404) { // Assume new game, empty data
                        console.log(`No save file found for ${gameKey} on server, starting fresh.`);
                        allLoadedCaughtData[gameKey] = {};
                    } else {
                        throw new Error(`HTTP error! status: ${response.status} for game ${gameKey}`);
                    }
                } else {
                    allLoadedCaughtData[gameKey] = await response.json();
                }
                console.log(`Successfully loaded caught data for ${gameKey} from server.`);
            } catch (error) {
                console.error(`Could not load caught data for ${gameKey} from server:`, error);
                console.log(`Falling back to localStorage for ${gameKey}.`);
                const localData = localStorage.getItem(`caughtPokemon-${gameKey}`);
                allLoadedCaughtData[gameKey] = localData ? JSON.parse(localData) : {};
            }
            caughtDataForCurrentGame = allLoadedCaughtData[gameKey];
            localStorage.setItem(`caughtPokemon-${gameKey}`, JSON.stringify(caughtDataForCurrentGame)); // Sync with local storage
        }

        async function saveCaughtStatus(pokemonId, isCaught) {
            const pkIdStr = pokemonId.toString();
            caughtDataForCurrentGame[pkIdStr] = isCaught;
            allLoadedCaughtData[currentGame] = caughtDataForCurrentGame; // Update cache
            localStorage.setItem(`caughtPokemon-${currentGame}`, JSON.stringify(caughtDataForCurrentGame));

            try {
                const response = await fetch(`/caught/${currentGame}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: pkIdStr, caught: isCaught }),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                console.log(`Save to server for ${currentGame} successful for Pokémon ${pkIdStr}.`);
            } catch (error) {
                console.error(`Failed to save to server for ${currentGame} for Pokémon ${pkIdStr}:`, error);
            }
            renderPokedexView(); // Re-render main Pokedex
            if (document.getElementById('areaDexView').classList.contains('active')) renderAreaPokemon(); // Re-render AreaDex if active
        }

        // --- POKEDEX VIEW ---
        function renderPokedexView() {
            pokedexGrid.innerHTML = '';
            const searchTerm = searchInput.value.toLowerCase();
            const showUncaught = showUncaughtOnlyCheckbox.checked;

            const filteredPokemon = pokemonData.filter(p => {
                const nameMatch = p.name.toLowerCase().includes(searchTerm) || p.id.toString().includes(searchTerm);
                const isCaught = caughtDataForCurrentGame[p.id.toString()] || false;
                const caughtFilterMatch = !showUncaught || !isCaught;
                return nameMatch && caughtFilterMatch;
            });

            if (filteredPokemon.length === 0) {
                pokedexGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">No Pokémon match your criteria.</p>`;
                updateNextToCatchHighlight();
                return;
            }

            filteredPokemon.forEach(pokemon => {
                const card = createPokemonCard(pokemon, currentGame, caughtDataForCurrentGame, saveCaughtStatus, showModal);
                pokedexGrid.appendChild(card);
            });
            updateNextToCatchHighlight();
        }

        function createPokemonCard(pokemon, gameKey, caughtData, onCaughtChange, onInfoClick) {
            const card = document.createElement('div');
            card.className = 'pokemon-card';
            card.dataset.id = pokemon.id;

            const isCaught = caughtData[pokemon.id.toString()] || false;
            const availabilityInfo = pokemon.availability[gameKey];

            const spriteImg = document.createElement('img');
            spriteImg.src = pokemon.sprite;
            spriteImg.alt = pokemon.name;
            spriteImg.className = 'pokemon-sprite mb-1';
            spriteImg.onerror = function() { this.src = `https://placehold.co/72x72/e0e0e0/757575?text=${pokemon.id}`; this.alt = 'Sprite not found';};

            const nameEl = document.createElement('h3');
            nameEl.className = 'text-md font-semibold text-gray-700 text-center leading-tight';
            nameEl.textContent = `#${pokemon.id.toString().padStart(3, '0')} ${pokemon.name}`;

            const typesContainer = document.createElement('div');
            typesContainer.className = 'flex flex-wrap justify-center my-1';
            pokemon.types.forEach(type => {
                const typeBadge = document.createElement('span');
                typeBadge.className = `type-badge type-${type.toLowerCase()}`;
                typeBadge.textContent = type;
                typesContainer.appendChild(typeBadge);
            });

            const caughtLabel = document.createElement('label');
            caughtLabel.className = 'flex items-center mt-1 cursor-pointer text-sm text-gray-600';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'caught-checkbox form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500';
            checkbox.checked = isCaught;
            checkbox.dataset.pokemonId = pokemon.id;
            checkbox.onchange = (e) => {
                onCaughtChange(e.target.dataset.pokemonId, e.target.checked);
            };
            caughtLabel.appendChild(checkbox);
            const caughtText = document.createElement('span');
            caughtText.textContent = ' Caught';
            caughtText.className = 'ml-1.5';
            caughtLabel.appendChild(caughtText);

            const infoButtonEl = document.createElement('button');
            infoButtonEl.className = 'info-button bg-blue-500 hover:bg-blue-700 text-white font-bold';
            infoButtonEl.textContent = 'Info';
            infoButtonEl.onclick = () => onInfoClick(pokemon, gameKey);

            card.appendChild(spriteImg);
            card.appendChild(nameEl);
            card.appendChild(typesContainer);

            if (availabilityInfo && !availabilityInfo.catchable && availabilityInfo.note) {
                const availNoteEl = document.createElement('p');
                availNoteEl.className = 'availability-note text-center text-xs';
                availNoteEl.textContent = availabilityInfo.note.length > 40 ? availabilityInfo.note.substring(0, 37) + "..." : availabilityInfo.note;
                card.appendChild(availNoteEl);
            }

            const controlsContainer = document.createElement('div');
            controlsContainer.className = 'flex items-center justify-between w-full mt-1';
            controlsContainer.appendChild(caughtLabel)
            controlsContainer.appendChild(infoButtonEl);
            card.appendChild(controlsContainer);

            return card;
        }

        function updateNextToCatchHighlight() {
            document.querySelectorAll('.next-to-catch').forEach(el => el.classList.remove('next-to-catch'));
            if (showUncaughtOnlyCheckbox.checked || searchInput.value.trim() !== '') return;

            const cards = pokedexGrid.querySelectorAll('.pokemon-card');
            for (const card of cards) {
                if (!caughtDataForCurrentGame[card.dataset.id.toString()]) {
                    card.classList.add('next-to-catch');
                    break;
                }
            }
        }

        // --- MODAL ---
        function showModal(pokemon, gameKey) {
            modalPokemonName.textContent = `#${pokemon.id.toString().padStart(3, '0')} ${pokemon.name}`;
            modalPokemonSprite.src = pokemon.sprite;
            modalPokemonSprite.onerror = function() { this.src = `https://placehold.co/96x96/e0e0e0/757575?text=${pokemon.id}`; this.alt = 'Sprite not found';};

            const catchInfo = pokemon.getCatchInfoForGame(gameKey);
            modalCatchInfo.innerHTML = catchInfo.replace(/\n/g, '<br>');

            const availabilityInfo = pokemon.availability[gameKey];
            if (availabilityInfo && !availabilityInfo.catchable && availabilityInfo.note) {
                modalAvailabilityNote.textContent = `Note for ${gameKey}: ${availabilityInfo.note}`;
                modalAvailabilityNote.style.display = 'block';
            } else if (availabilityInfo && availabilityInfo.catchable && availabilityInfo.note) {
                 modalAvailabilityNote.textContent = `Note for ${gameKey}: ${availabilityInfo.note}`; // Show note even if catchable
                 modalAvailabilityNote.style.display = 'block';
            }
            else {
                modalAvailabilityNote.style.display = 'none';
            }
            modal.style.display = "flex";
        }
        function closeModal() { modal.style.display = "none"; }
        window.onclick = (event) => { if (event.target == modal) closeModal(); };


        // --- AREA DEX ---
        function initializeAreaDex() {
            const selectedGame = areaGameSelector.value || currentGame; // Use current game if area game selector is not set
            if(areaGameSelector.value !== selectedGame && areaGameSelector.options.namedItem(selectedGame) && !areaGameSelector.options.namedItem(selectedGame).disabled) {
                areaGameSelector.value = selectedGame;
            }
            populateAreaSelector(selectedGame);
            renderAreaPokemon();
        }

        function handleAreaGameChange() {
            const selectedGame = areaGameSelector.value;
            populateAreaSelector(selectedGame);
            renderAreaPokemon(); // Will show placeholder if no area selected
        }

        function populateAreaSelector(gameKey) {
            areaSelector.innerHTML = '<option value="">-- Select Area --</option>';
            if (!allGameLocations[gameKey]) {
                const locations = new Set();
                pokemonData.forEach(p => {
                    if (p.availability[gameKey] && p.availability[gameKey].locations) {
                        p.availability[gameKey].locations.forEach(loc => locations.add(loc.trim()));
                    }
                });
                allGameLocations[gameKey] = Array.from(locations).sort();
            }

            allGameLocations[gameKey].forEach(loc => {
                const option = document.createElement('option');
                option.value = loc;
                option.textContent = loc;
                areaSelector.appendChild(option);
            });
        }

        async function renderAreaPokemon() {
            areaPokemonGrid.innerHTML = '';
            const selectedGame = areaGameSelector.value;
            const selectedArea = areaSelector.value;

            if (!selectedGame || !selectedArea) {
                areaPokemonGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">Select a game and area.</p>`;
                return;
            }

            // Ensure caught data for the selected game in Area Dex is loaded
            if (!allLoadedCaughtData[selectedGame]) {
                await loadCaughtDataForGame(selectedGame);
            }
            const currentAreaCaughtData = allLoadedCaughtData[selectedGame] || {};

            const pokemonInArea = pokemonData.filter(p =>
                p.availability[selectedGame] &&
                p.availability[selectedGame].locations &&
                p.availability[selectedGame].locations.includes(selectedArea) &&
                p.availability[selectedGame].catchable // Only show if directly catchable in that area for that game
            );

            if (pokemonInArea.length === 0) {
                areaPokemonGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">No Pokémon found in ${selectedArea} for ${gameSelector.options[gameSelector.selectedIndex].text}.</p>`;
                return;
            }

            pokemonInArea.forEach(pokemon => {
                // For AreaDex, onCaughtChange should still use the 'currentGame' context for saving,
                // but display based on 'selectedGame' for caught status.
                // This assumes user wants to mark caught status based on their main game selection.
                // Or, we can pass 'selectedGame' to saveCaughtStatus if AreaDex should save for its own selected game.
                // For now, let's use the main 'currentGame' for saving consistency.
                const card = createPokemonCard(pokemon, selectedGame, currentAreaCaughtData,
                    (pkId, caughtStatus) => saveCaughtStatusForSpecificGame(selectedGame, pkId, caughtStatus), // Special save for area dex
                    showModal);
                areaPokemonGrid.appendChild(card);
            });
        }

        async function saveCaughtStatusForSpecificGame(gameKey, pokemonId, isCaught) {
            // This function is similar to saveCaughtStatus but specifically for a gameKey
            // that might be different from the global 'currentGame' (e.g. when using Area Dex for a different game)
            const pkIdStr = pokemonId.toString();
            if (!allLoadedCaughtData[gameKey]) {
                allLoadedCaughtData[gameKey] = {};
            }
            allLoadedCaughtData[gameKey][pkIdStr] = isCaught;
            localStorage.setItem(`caughtPokemon-${gameKey}`, JSON.stringify(allLoadedCaughtData[gameKey]));

            try {
                const response = await fetch(`/caught/${gameKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: pkIdStr, caught: isCaught }),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                console.log(`Save to server for ${gameKey} successful for Pokémon ${pkIdStr}.`);
            } catch (error) {
                console.error(`Failed to save to server for ${gameKey} for Pokémon ${pkIdStr}:`, error);
            }
            // Re-render the currently active view
            if (document.getElementById('pokedexView').classList.contains('active')) renderPokedexView();
            if (document.getElementById('areaDexView').classList.contains('active')) renderAreaPokemon();
        }


        // --- TRADE HELPER ---
        function initializeTradeHelper() {
            // Ensure selectors are populated and default to different games if possible
            if (tradeMyGameSelector.options.length > 0 && tradePartnerGameSelector.options.length > 0) {
                if (tradeMyGameSelector.value === tradePartnerGameSelector.value) {
                    // Try to set partner game to a different one
                    for (let i = 0; i < tradePartnerGameSelector.options.length; i++) {
                        if (tradePartnerGameSelector.options[i].value !== tradeMyGameSelector.value && !tradePartnerGameSelector.options[i].disabled) {
                            tradePartnerGameSelector.selectedIndex = i;
                            break;
                        }
                    }
                }
            }
            tradeResultsPlaceholder.style.display = 'block';
            canReceiveTradesList.innerHTML = '';
            canSendTradesList.innerHTML = '';
        }

        async function executeTradeSearch() {
            tradeResultsPlaceholder.style.display = 'none';
            canReceiveTradesList.innerHTML = '<li>Loading...</li>';
            canSendTradesList.innerHTML = '<li>Loading...</li>';

            const myGameKey = tradeMyGameSelector.value;
            const partnerGameKey = tradePartnerGameSelector.value;

            if (myGameKey === partnerGameKey) {
                canReceiveTradesList.innerHTML = '<li>Please select two different games.</li>';
                canSendTradesList.innerHTML = '';
                return;
            }

            await loadCaughtDataForGame(myGameKey, true); // Force reload to ensure latest
            await loadCaughtDataForGame(partnerGameKey, true); // Force reload

            const myCaughtData = allLoadedCaughtData[myGameKey] || {};
            const partnerCaughtData = allLoadedCaughtData[partnerGameKey] || {};

            let canReceiveHTML = '';
            let canSendHTML = '';
            let receivedCount = 0;
            let sentCount = 0;

            pokemonData.forEach(p => {
                const pkIdStr = p.id.toString();
                const iHaveIt = myCaughtData[pkIdStr] || false;
                const partnerHasIt = partnerCaughtData[pkIdStr] || false;
                const iCanGetItInMyGame = p.availability[myGameKey]?.catchable || false; // Is it generally catchable in my game?
                const partnerCanGetItInTheirGame = p.availability[partnerGameKey]?.catchable || false;


                // Pokémon I can receive: I don't have it, partner has it.
                // Bonus: it's hard for me to get in my game, or partner has it and it's easy for them.
                if (!iHaveIt && partnerHasIt) {
                     // Check if this Pokémon is generally available in my game. If not, it's a good trade.
                    let tradeNote = "";
                    if (!p.availability[myGameKey]?.catchable && p.availability[myGameKey]?.note) {
                        tradeNote = ` <span class="text-xs italic text-gray-500">(${p.availability[myGameKey].note})</span>`;
                    }
                    canReceiveHTML += `<li>#${pkIdStr.padStart(3,'0')} ${p.name}${tradeNote}</li>`;
                    receivedCount++;
                }

                // Pokémon I can send: Partner doesn't have it, I have it.
                // Bonus: it's hard for partner to get in their game, or I have it and it's easy for me.
                if (!partnerHasIt && iHaveIt) {
                    let tradeNote = "";
                     if (!p.availability[partnerGameKey]?.catchable && p.availability[partnerGameKey]?.note) {
                        tradeNote = ` <span class="text-xs italic text-gray-500">(Partner needs for: ${p.availability[partnerGameKey].note})</span>`;
                    }
                    canSendHTML += `<li>#${pkIdStr.padStart(3,'0')} ${p.name}${tradeNote}</li>`;
                    sentCount++;
                }
            });

            canReceiveTradesList.innerHTML = receivedCount > 0 ? canReceiveHTML : '<li>Nothing specific found based on current caught data.</li>';
            canSendTradesList.innerHTML = sentCount > 0 ? canSendHTML : '<li>Nothing specific found based on current caught data.</li>';
        }

        // --- STARTUP ---
        initializeApp();
    </script>

</body>
</html>
